<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body, html {
        font-family: 'Inter', sans-serif;
        color: #1c1e21;
        height: 100%;
        margin: 0;
        /* background-image: url('./images/yoyo.jpg'); Add this line */
        background-size: cover; /* Ensures the image covers the whole body */
        background-position: center; /* Centers the image */
        background-attachment: fixed; /* Keeps the background static when scrolling */
    }
    .user-message {
        background-color: #1D4ED8; /* A calm, dark blue */
        color: white;
    }
    .ai-message-bubble {
        background-color: #F3F4F6; /* Light gray */
        color: #111827;
    }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9CA3AF;
            margin: 0 2px;
            animation: bounce 1.2s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        .mic-button.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
            70% { box-shadow: 0 0 0 30px rgba(22, 163, 74, 0); }
            100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
        }
        #ai-avatar-video {
            animation: breathe 4s ease-in-out infinite;
        }
        #ai-avatar-video.speaking {
            animation: speak 0.8s ease-in-out infinite;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        @keyframes speak {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        /* Custom scrollbar for a cleaner look */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #D1D5DB;
            border-radius: 20px;
        }
    </style>
</head>
<body class="antialiased bg-slate-50" >

    <div id="chat-container" class="flex flex-col h-full max-w-4xl mx-auto">
        <header class="w-full p-4 flex-shrink-0 text-center relative flex items-center justify-center" >
            <a href="./user-dashboard.html" class="absolute left-4 top-1/2 -translate-y-1/2 flex items-center space-x-2 text-slate-600 hover:text-slate-900 transition-colors bg-slate-100 hover:bg-slate-200 px-3 py-2 rounded-lg text-sm font-medium">
                <!-- <i data-lucide="layout-dashboard" class="w-5 h-5"></i> -->
                <i data-lucide="brain" class="w-5 h-5"></i>
                <span>Dashboard</span>
            </a>
            <h1 class="text-2xl font-bold text-slate-800">Aura AI</h1>
        </header>

        <main id="chat-messages" class="flex-1 px-4 overflow-y-auto flex flex-col space-y-4 pb-4">
            <div class="flex items-end space-x-3 max-w-lg">
                <div class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center flex-shrink-0">
                    <i data-lucide="brain" class="w-5 h-5 text-slate-600"></i>
                </div>
                <div class="ai-message-bubble rounded-2xl py-3 px-5 shadow-sm">
                    <p>Hello! How can I assist you today?</p>
                </div>
            </div>
        </main>

        <footer class="w-full p-4 flex-shrink-0">
            <div class="relative bg-white rounded-2xl p-2 shadow-lg border border-slate-200 flex items-end space-x-2">
                <div class="relative">
                    <button id="tools-button" class="p-3 text-slate-500 hover:bg-slate-100 rounded-full transition-colors">
                        <i data-lucide="plus-circle" class="w-6 h-6"></i>
                    </button>
                    <div id="tools-menu" class="hidden absolute bottom-full mb-2 bg-white rounded-lg shadow-xl border border-slate-200 w-48 py-2">
                        <button id="start-voice" class="w-full flex items-center space-x-3 px-4 py-2 text-left text-slate-700 hover:bg-slate-100">
                            <i data-lucide="phone-call" class="w-5 h-5 text-green-600"></i>
                            <span>Voice Connection</span>
                        </button>
                        <button id="start-video" class="w-full flex items-center space-x-3 px-4 py-2 text-left text-slate-700 hover:bg-slate-100">
                            <i data-lucide="video" class="w-5 h-5 text-purple-600"></i>
                            <span>Video Connection</span>
                        </button>
                    </div>
                </div>
                
                <textarea id="chat-input" placeholder="Message Aura..." rows="1" class="w-full px-2 py-3 bg-transparent focus:outline-none resize-none text-slate-800 self-center"></textarea>
                
                <button id="chat-send-button" class="bg-blue-700 text-white rounded-xl p-3 font-semibold hover:bg-blue-800 transition-colors focus:outline-none disabled:bg-blue-300 disabled:cursor-not-allowed">
                    <i data-lucide="send-horizontal" class="w-6 h-6"></i>
                </button>
            </div>
        </footer>
    </div>

    <div id="voice-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex flex-col items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 text-center flex flex-col items-center">
            <div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-6">
                <i data-lucide="brain" class="w-10 h-10 text-slate-600"></i>
            </div>
            <p id="mic-status" class="text-xl text-slate-600 mb-8 h-8">Click the mic to start speaking</p>
            <button id="mic-button" class="mic-button bg-green-600 text-white rounded-full p-8 shadow-lg hover:bg-green-700 focus:outline-none transition-transform transform hover:scale-110 z-10">
                <i data-lucide="mic" class="w-12 h-12"></i>
            </button>
            <button class="voice-hang-up-button mt-12 flex items-center gap-2 bg-slate-200 text-red-600 font-bold py-2 px-4 rounded-lg transition-colors hover:bg-red-500 hover:text-white">
                <i data-lucide="phone-off" class="w-5 h-5"></i> Hang Up
            </button>
        </div>
    </div>
    
    <div id="video-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-90 flex flex-col items-center justify-center z-50">
        <video id="user-video" class="absolute top-4 right-4 w-48 h-36 rounded-lg shadow-2xl border-2 border-white object-cover" autoplay muted></video>
        
        <div id="ai-avatar-container" class="relative w-48 h-48 sm:w-56 sm:h-56 mb-8">
             <div id="ai-avatar-video" class="w-full h-full rounded-full bg-gradient-to-br from-purple-400 to-indigo-500 opacity-80"></div>
             <div class="absolute inset-0 border-4 border-purple-300 rounded-full opacity-50 animate-ping"></div>
        </div>
        <p id="video-mic-status" class="text-white bg-black/30 backdrop-blur-sm px-4 py-2 rounded-full text-lg h-10 mb-24"></p>
        
        <div class="absolute bottom-8 bg-black/40 backdrop-blur-md rounded-full p-3 flex items-center space-x-4">
            <button id="video-mic-button" class="mic-button bg-green-600 text-white rounded-full p-4 hover:bg-green-700 focus:outline-none transition-colors">
                <i data-lucide="mic" class="w-7 h-7"></i>
            </button>
            <button id="video-hang-up-button" class="bg-red-600 text-white rounded-full p-4 hover:bg-red-700 focus:outline-none transition-colors">
                <i data-lucide="phone-off" class="w-7 h-7"></i>
            </button>
        </div>
    </div>
   
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // --- UI ELEMENT REFERENCES ---
            const chatInput = document.getElementById('chat-input');
            const chatSendButton = document.getElementById('chat-send-button');
            const chatMessages = document.getElementById('chat-messages');
            const toolsButton = document.getElementById('tools-button');
            const toolsMenu = document.getElementById('tools-menu');
            
            const voiceModal = document.getElementById('voice-modal');
            const micButton = document.getElementById('mic-button');
            const micStatus = document.getElementById('mic-status');

            const videoModal = document.getElementById('video-modal');
            const userVideo = document.getElementById('user-video');
            const aiAvatarVideo = document.getElementById('ai-avatar-video');
            const videoMicStatus = document.getElementById('video-mic-status');
            const videoMicButton = document.getElementById('video-mic-button');

            // --- GLOBAL STATE ---
            let currentMode = 'chat'; // 'chat', 'voice', or 'video'
            let localStream;
            let softVoice = null;
            
            // --- UI MANAGEMENT ---
            const toggleToolsMenu = () => toolsMenu.classList.toggle('hidden');
            toolsButton.addEventListener('click', toggleToolsMenu);

            document.getElementById('start-voice').addEventListener('click', () => {
                toggleToolsMenu();
                currentMode = 'voice';
                voiceModal.classList.remove('hidden');
                speakText("Voice connection established. Click the mic to talk.");
            });

            document.getElementById('start-video').addEventListener('click', () => {
                toggleToolsMenu();
                currentMode = 'video';
                startVideoCall();
            });

            const hangUp = () => {
                window.speechSynthesis.cancel();
                if(recognition) recognition.stop();
                
                if(localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                voiceModal.classList.add('hidden');
                videoModal.classList.add('hidden');
                currentMode = 'chat';
            };
            document.querySelectorAll('.voice-hang-up-button, #video-hang-up-button').forEach(btn => btn.addEventListener('click', hangUp));
            
            // Auto-resizing textarea
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = (chatInput.scrollHeight) + 'px';
                chatSendButton.disabled = chatInput.value.trim() === '';
            });

            // --- VOICE & SPEECH LOGIC ---
            const loadVoices = () => {
                const voices = window.speechSynthesis.getVoices();
                softVoice = voices.find(voice => voice.name.includes('Female') && voice.lang === 'en-US' && voice.localService) || voices.find(voice => voice.name.includes('Zira') && voice.lang === 'en-US') || voices.find(voice => voice.lang === 'en-US');
            };
            loadVoices();
            if (window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = loadVoices;

            // --- MESSAGE & AI RESPONSE HANDLING ---
            const addMessage = (sender, text) => {
                const aiAvatarHTML = `
                    <div class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center flex-shrink-0">
                        <i data-lucide="brain" class="w-5 h-5 text-slate-600"></i>
                    </div>`;
                
                const messageContainer = document.createElement('div');
                let messageElementHTML = '';

                if (sender === 'user') {
                    messageContainer.className = 'flex justify-end';
                    messageElementHTML = `<div class="user-message rounded-2xl py-3 px-5 max-w-lg shadow-sm"><p>${text}</p></div>`;
                } else {
                    messageContainer.className = 'flex items-end space-x-3 max-w-lg';
                    messageElementHTML = `${aiAvatarHTML}<div class="ai-message-bubble rounded-2xl py-3 px-5 shadow-sm"><p>${text}</p></div>`;
                }
                messageContainer.innerHTML = messageElementHTML;
                chatMessages.appendChild(messageContainer);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                lucide.createIcons();
            };
            
            const showTypingIndicator = () => {
                 const typingIndicatorHTML = `
                    <div id="typing-indicator" class="flex items-end space-x-3 max-w-lg">
                        <div class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center flex-shrink-0">
                            <i data-lucide="brain-circuit" class="w-5 h-5 text-slate-600"></i>
                        </div>
                        <div class="ai-message-bubble rounded-2xl py-3 px-5 shadow-sm">
                            <div class="typing-indicator"><span></span><span></span><span></span></div>
                        </div>
                    </div>`;
                const indicatorContainer = document.createElement('div');
                indicatorContainer.innerHTML = typingIndicatorHTML;
                chatMessages.appendChild(indicatorContainer);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                lucide.createIcons();
            };

            const removeTypingIndicator = () => {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            };

            const sendTextMessage = async () => {
                const messageText = chatInput.value.trim();
                if (messageText === '') return;
                addMessage('user', messageText);
                chatInput.value = '';
                chatInput.style.height = 'auto';
                chatSendButton.disabled = true;
                showTypingIndicator();
                await getAIResponse(messageText);
            };
            
            const getAIResponse = async (messageText) => {
                 try {
                    const response = await fetch('http://127.0.0.1:5000/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: messageText })});
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    const aiReply = data.reply;
                    
                    removeTypingIndicator();
                    if (currentMode === 'voice' || currentMode === 'video') {
                        speakText(aiReply);
                    } else { 
                        addMessage('ai', aiReply); 
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    const errorMessage = "Sorry, I'm having trouble connecting right now. Please try again later.";
                    removeTypingIndicator();
                    if (currentMode === 'voice' || currentMode === 'video') {
                        speakText(errorMessage);
                    } else { 
                        addMessage('ai', errorMessage); 
                    }
                }
            };
            chatSendButton.addEventListener('click', sendTextMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendTextMessage();
                }
            });
            
            // --- SPEECH RECOGNITION & SYNTHESIS ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;

                const updateStatus = (text) => {
                    if(currentMode === 'voice') micStatus.textContent = text;
                    if(currentMode === 'video') videoMicStatus.textContent = text;
                };
                recognition.onstart = () => { updateStatus("Listening..."); micButton.classList.add('listening'); videoMicButton.classList.add('listening'); };
                recognition.onend = () => { updateStatus("Click the mic to speak"); micButton.classList.remove('listening'); videoMicButton.classList.remove('listening'); };
                recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); updateStatus("Sorry, I didn't catch that."); };
                recognition.onresult = async (event) => { const spokenText = event.results[0][0].transcript; updateStatus(`Processing...`); await getAIResponse(spokenText); };
            } else {
                document.getElementById('start-voice').style.display = 'none';
                document.getElementById('start-video').style.display = 'none';
            }

            const speakText = (text) => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                if (softVoice) utterance.voice = softVoice;
                utterance.pitch = 1.1; utterance.rate = 0.95; 

                utterance.onstart = () => {
                    if(currentMode === 'voice') micStatus.textContent = "Aura is speaking...";
                    if(currentMode === 'video') { videoMicStatus.textContent = "Aura is speaking..."; aiAvatarVideo.classList.add('speaking'); }
                };
                utterance.onend = () => {
                     if(currentMode === 'voice') micStatus.textContent = "Click the mic to speak";
                     if(currentMode === 'video') { videoMicStatus.textContent = "Click the mic to speak"; aiAvatarVideo.classList.remove('speaking'); }
                };
                window.speechSynthesis.speak(utterance);
            };
            
            function startListening() {
                if (!recognition) return;
                try { window.speechSynthesis.cancel(); recognition.start(); } 
                catch(e) { console.error("Recognition already started.", e); }
            }
            micButton.addEventListener('click', startListening);
            videoMicButton.addEventListener('click', startListening);

            // --- VIDEO CALL FUNCTIONS ---
            const startVideoCall = async () => {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    userVideo.srcObject = localStream;
                    videoModal.classList.remove('hidden');
                    speakText("Video connection enabled. When you're ready, press the mic to talk.");
                } catch (err) {
                    console.error("Error accessing camera/mic:", err);
                    alert("Could not access your camera or microphone. Please check permissions and try again.");
                    hangUp();
                }
            };

            // Initial state
            chatSendButton.disabled = true;
        });
    </script>
</body>
</html>